generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  telegramId String  @unique
  whatsapp   String?
  name       String?
  active     Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  preferences   Preference[]
  resumes       Resume[]
  jobDeliveries JobDelivery[]
}

model Preference {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user     User    @relation(fields: [userId], references: [id])
  userId   String  @db.Uuid
  keyword  String
  location String?
  remote   Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)
}

model Resume {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique @db.Uuid

  resumeJson Json
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @db.Timestamp(6)
}

model Job {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  company       String
  link          String        @unique
  source        String
  description   String
  keyword       String
  createdAt     DateTime      @default(now()) @db.Timestamp(6)
  updatedAt     DateTime      @updatedAt @db.Timestamp(6)
  alert         Alert?
  jobDeliveries JobDelivery[]
}

model JobDelivery {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  job         Job      @relation(fields: [jobId], references: [id])
  jobId       String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @db.Uuid
  deliveredAt DateTime @default(now()) @db.Timestamp(6)

  @@unique([jobId, userId]) // ensures no duplicates
}

model Alert {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  job         Job      @relation(fields: [jobId], references: [id])
  jobId       String   @unique @db.Uuid
  userId      String   @unique @db.Uuid
  coverLetter String
  resumeJson  Json
  sentAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @db.Timestamp(6)
}
